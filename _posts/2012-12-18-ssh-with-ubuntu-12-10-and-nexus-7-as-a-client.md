---
layout: post
title: SSH with Ubuntu 12.10 and nexus 7 as a client
date: 2012-12-18 01:25:00.000000000 -05:00
categories:
- Android
- Network
- Staff Picks
tags: []
status: publish
type: post
published: true
meta:
  blogger_blog: www.techronicles.net
  blogger_author: Kenneth Massada
  blogger_ff04fb872097e84c3f74ac8dafe273de_permalink: '8420100632604883564'

excerpt: !ruby/object:Hpricot::Doc

---
<p>I woke up one day and decided to view my logs, and I see someone poking hard at my ssh connection, trying to connect with a bunch of bogus usernames and passwords. Here are few tips to fend up the most basic of the attacks.
<div></div>
<div>SERVER: what you are trying to connect to. </div>
<div>CLIENT: what you connecting with</div>
<div></div>
<div>First edit your /etc/hosts.deny and /etc/hosts.allow. Block and accept connections from your local network and vpn network. </div>
<div><span style="color:orange;"><br /></span></div>
<div><span style="color:orange;">ON THE SERVER</span><br />
<blockquote class="tr_bq"><span style="color:orange;"><br /></span><span id="internal-source-marker_0.031920691253617406"><span style="font-family:Courier New, Courier, monospace;"><span style="font-size:15px;vertical-align:baseline;white-space:pre-wrap;">sudo vi /etc/hosts.deny</span></span></span> </p></blockquote>
<blockquote class="tr_bq"><p><span id="internal-source-marker_0.031920691253617406"><span style="font-family:Courier New, Courier, monospace;"><span style="font-size:15px;vertical-align:baseline;white-space:pre-wrap;"></span></span></span># /etc/hosts.deny: list of hosts that are _not_ allowed to access the system.<br />#                  See the manual pages hosts_access(5) and hosts_options(5).<br />#<br /># Example:    ALL: some.host.name, .some.domain<br />#             ALL EXCEPT in.fingerd: other.host.name, .other.domain<br />#<br /># If you're going to protect the portmapper use the name "portmap" for the<br /># daemon name. Remember that you can only use the keyword "ALL" and IP<br /># addresses (NOT host or domain names) for the portmapper, as well as for<br /># rpc.mountd (the NFS mount daemon). See portmap(8) and rpc.mountd(8)<br /># for further information.<br />#<br /># The PARANOID wildcard matches any host whose name does not match its<br /># address.<br />#<br /># You may wish to enable this to ensure any programs that don't<br /># validate looked up hostnames still leave understandable logs. In past<br /># versions of Debian this has been the default.<br /># ALL: PARANOID<br /># rpcbind mountd nfsd statd lockd rquotad : ALL<b><br /></b><b>ALL: ALL</b><b>ALL: 60.169.22.118</b><b>in.telnetd: ALL</b></p></blockquote>
</div>
<div>you can get fancy with the allow, by only restricting to a very tight window of ips using netmasking. </div>
<div>
<p><a name="more"></a><br />
<blockquote class="tr_bq"><span style="font-family:Courier New, Courier, monospace;">sudo vi /etc/hosts.allow</span> </p></blockquote>
<blockquote class="tr_bq"><p><span style="font-family:Courier New, Courier, monospace;"></span># /etc/hosts.allow: list of hosts that are allowed to access the system.<br /># See the manual pages hosts_access(5) and hosts_options(5).<br />#<br /># Example: ALL: LOCAL @some_netgroup<br /># ALL: .foobar.edu EXCEPT terminalserver.foobar.edu<br />#<br /># If you're going to protect the portmapper use the name "portmap" for the<br /># daemon name. Remember that you can only use the keyword "ALL" and IP<br /># addresses (NOT host or domain names) for the portmapper, as well as for<br /># rpc.mountd (the NFS mount daemon). See portmap(8) and rpc.mountd(8)<br /># for further information.<br />#<br /># rpcbind mountd nfsd statd lockd rquotad : list of IP addresses<br /><b> openvpn sshd: 192.168.12.0/255.255.255.248 10.85.0.0/255.255.255.252</b></p></blockquote>
<p><span style="color:orange;">ON THE SERVER</span><br /><span style="font-family:Arial;font-size:15px;vertical-align:baseline;white-space:pre-wrap;">on the server edit </span><span style="font-family:Arial;font-size:15px;vertical-align:baseline;white-space:pre-wrap;">/etc/ssh/sshd_config</span><span style="font-family:Arial;font-size:15px;vertical-align:baseline;white-space:pre-wrap;"> make sure you can access ssh with Password</span><br /><b style="font-family:Arial;font-size:15px;white-space:pre-wrap;"><span style="color:red;">PasswordAuthentication yes</span></b></p>
<p>We will disallow users to ssh with a password later, but this needs to be enabled so you can copy ssh keys to the host you tying to connect to.</p>
<p><span style="font-family:Arial;font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;"></span><span style="color:orange;">ON THE CLIENT</span><br /><span style="font-family:Arial;font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;">Create a public and private SSH key on the command-line, increase number of bits to 4096, for added security protect with a password</span><br /><span style="font-family:'Courier New', Courier, monospace;font-size:15px;vertical-align:baseline;white-space:pre-wrap;"><br /></span><span style="font-family:'Courier New', Courier, monospace;font-size:15px;vertical-align:baseline;white-space:pre-wrap;">mkdir ~/.ssh</span><br /><span style="font-family:'Courier New', Courier, monospace;font-size:15px;vertical-align:baseline;white-space:pre-wrap;">chmod 700 ~/.ssh</span><br /><span style="font-family:'Courier New', Courier, monospace;font-size:15px;vertical-align:baseline;white-space:pre-wrap;">cd ~/.ssh</span><br /><span style="font-family:'Courier New', Courier, monospace;font-size:15px;vertical-align:baseline;white-space:pre-wrap;">ssh-keygen -t rsa -b 4096 </span><br /><span style="color:orange;"><br /></span><span style="color:orange;"><br /></span><span style="color:orange;">ON THE NEXUS</span></p>
<p><a href="https://play.google.com/store/apps/details?id=org.connectbot" target="_blank">ConnectBot</a>
<div class="separator" style="clear:both;text-align:center;"><a href="https://play.google.com/store/apps/details?id=org.connectbot" style="clear:left;float:left;margin-bottom:1em;margin-right:1em;"><img border="0" src="/images/wp/2e7da-unnamed1.png" /></a></div>
<p>Download this app from the play store. I won't walk you through every screen, there were too many of them .</p>
<p>Click <b>Menu &gt; Manage Pubkeys &gt; Generate</b><br />Use 4096 bit, and a password
<div class="separator" style="clear:both;text-align:center;"></div>
<div class="separator" style="clear:both;text-align:left;"><a href="#" style="margin-left:1em;margin-right:1em;"><img border="0" height="640" src="/images/wp/422d5-2012-12-1723-52-39.png?w=187" width="400" /></a></div>
<p>this is the fun part, <b>randomly touch screen </b>to generate an entropy</p>
<div class="separator" style="clear:both;text-align:left;"><a href="#" style="margin-left:1em;margin-right:1em;"><img border="0" height="640" src="/images/wp/f51b7-2012-12-1723-53-10.png?w=187" width="400" /></a></div>
<p>Once that is done, <b>long press key</b>, and <b>check key on start</b>.  and <b>long press copy public key</b><br /><b><br /></b>
<div class="separator" style="clear:both;text-align:left;"><a href="#" style="margin-left:1em;margin-right:1em;"><img border="0" height="640" src="/images/wp/aea6c-2012-12-1723-54-45.png?w=187" width="400" /></a></div>
<p>Go back to the main screen and create an ssh session, I have a dns server, but if you don't you might want to enter the ip of the host</p>
<div class="separator" style="clear:both;text-align:left;"><a href="#" style="margin-left:1em;margin-right:1em;"><img border="0" height="640" src="/images/wp/db65a-2012-12-1723-57-09.png?w=187" width="400" /></a></div>
<p>Before you connect, <b>long press, and edit host</b> you should load keys, it should say<b>, Use pubkey,</b> and you select the one you just created.</p>
<p><b>It will fail with the key</b>, because you haven't copied it over just yet. you'll have to enter the password, when you get here, do</p>
<p><b>echo "press menu and paste, your key should paste here" &gt;&gt; .ssh/authorized_keys </b></p>
<div class="separator" style="clear:both;text-align:left;">I am not showing the key to my ssh key lol, don't have the intention to create another one, trust me it  should work. :)</div>
<div class="separator" style="clear:both;text-align:left;"></div>
<div class="separator" style="clear:both;text-align:left;">After that exit the session, by pressing, <b>Menu &gt; Disconnect</b>. </div>
<div class="separator" style="clear:both;text-align:left;"></div>
<div class="separator" style="clear:both;text-align:left;">Click back on the session, to make sure you can connect directly no passwords, the only password being the one to the key. </div>
<p><span style="font-family:Arial;font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;"></span><span style="color:orange;">ON THE CLIENT</span><br /><span style="font-family:'Courier New', Courier, monospace;font-size:15px;white-space:pre-wrap;">ssh-copy-id -i .ssh/id_rsa.pub kenneth@192.168.12.2</span></div>
<div><span style="color:orange;"><br /></span><span style="font-family:Arial;font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;"></span><span style="color:orange;">ON THE SERVER</span><br /><span style="font-family:Arial;font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;">Now edit </span><span style="font-family:Arial;font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;">/etc/ssh/sshd_config</span><span style="font-family:Arial;font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;">, watch the highlighted values</span><br />
<blockquote class="tr_bq"># Package generated configuration file<br /># See the sshd_config(5) manpage for details<br /># What ports, IPs and protocols we listen for<br /><b>Port 5848 #use a non standard port</b># Use these options to restrict which interfaces/protocols sshd will bind to<br />#ListenAddress ::<br />#ListenAddress 0.0.0.0<br /><b>Protocol 2 #use protocol 2 more secure</b># HostKeys for protocol version 2<br />HostKey /etc/ssh/ssh_host_rsa_key<br />HostKey /etc/ssh/ssh_host_dsa_key<br />HostKey /etc/ssh/ssh_host_ecdsa_key<br />#Privilege Separation is turned on for security<br />UsePrivilegeSeparation yes<br /># Lifetime and size of ephemeral version 1 server key<br /><b>KeyRegenerationInterval 3600</b><b>ServerKeyBits 4096</b><b>AllowUsers kenneth #specify what user can connect</b># Logging<br />SyslogFacility AUTH<br /><b>LogLevel VERBOSE #log everything</b> # Authentication:<br /><b>LoginGraceTime 20 #tighten this time</b><b> PermitRootLogin no #NEVER LET ROOT IN</b><b>StrictModes yes</b><b>RSAAuthentication yes</b><b>PubkeyAuthentication yes</b>#AuthorizedKeysFile     %h/.ssh/authorized_keys<br /># Don't read the user's ~/.rhosts and ~/.shosts files<br /><b>IgnoreRhosts yes</b># For this to work you will also need host keys in /etc/ssh_known_hosts<br />RhostsRSAAuthentication no<br /># similar for protocol version 2<br /><b>HostbasedAuthentication no</b># Uncomment if you don't trust ~/.ssh/known_hosts for RhostsRSAAuthentication<br />#IgnoreUserKnownHosts yes<br /># To enable empty passwords, change to yes (NOT RECOMMENDED)<br /><b>PermitEmptyPasswords no</b># Change to yes to enable challenge-response passwords (beware issues with<br /># some PAM modules and threads)<br /><b>ChallengeResponseAuthentication no</b># Change to no to disable tunnelled clear text passwords<br /><b>PasswordAuthentication no</b># Kerberos options<br />#KerberosAuthentication no<br />#KerberosGetAFSToken no<br />#KerberosOrLocalPasswd yes<br />#KerberosTicketCleanup yes<br /># GSSAPI options<br />#GSSAPIAuthentication no<br />#GSSAPICleanupCredentials yes<br /><b>X11Forwarding no #x11vnc different certs</b>X11DisplayOffset 10<br />PrintMotd no<br />PrintLastLog yes<br />TCPKeepAlive yes<br />#UseLogin no<br />#MaxStartups 10:30:60<br /><b>Banner /etc/issue.net</b># Allow client to pass locale environment variables<br />AcceptEnv LANG LC_*<br />Subsystem sftp /usr/lib/openssh/sftp-server<br /># Set this to 'yes' to enable PAM authentication, account processing,<br /># and session processing. If this is enabled, PAM authentication will<br /># be allowed through the ChallengeResponseAuthentication and<br /># PasswordAuthentication.  Depending on your PAM configuration,<br /># PAM authentication via ChallengeResponseAuthentication may bypass<br /># the setting of "PermitRootLogin without-password".<br /># If you just want the PAM account and session checks to run without<br /># PAM authentication, then enable this but set PasswordAuthentication<br /># and ChallengeResponseAuthentication to 'no'.<br /><b>UsePAM yes</b></p></blockquote>
</div>
<p><span style="font-family:Courier New, Courier, monospace;"><span style="font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;">sudo vi </span><span style="font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;">/etc/issue</span></span><br /><span style="font-family:Arial;"><span style="font-size:15px;white-space:pre-wrap;">Makes it look like some FBI type warning when you login, you can get fancy here. </span></span></p>
<blockquote class="tr_bq"><p>***************************************************************************<br />NOTICE TO USERS<br />This computer system is the private property of its owner, whether<br />individual, corporate or government.  It is for authorized use only.<br />Users (authorized or unauthorized) have no explicit or implicit<br />expectation of privacy.<br />Any or all uses of this system and all files on this system may be<br />intercepted, monitored, recorded, copied, audited, inspected, and<br />disclosed to your employer, to authorized site, government, and law<br />enforcement personnel, as well as authorized officials of government<br />agencies, both domestic and foreign.<br />By using this system, the user consents to such interception, monitoring,<br />recording, copying, auditing, inspection, and disclosure at the<br />discretion of such personnel or officials.  Unauthorized or improper use<br />of this system may result in civil and criminal penalties and<br />administrative or disciplinary action, as appropriate. By continuing to<br />use this system you indicate your awareness of and consent to these terms<br />and conditions of use. LOG OFF IMMEDIATELY if you do not agree to the<br />conditions stated in this warning.<br />****************************************************************************</p></blockquote>
<div><span style="font-family:Arial;"><span style="font-size:15px;white-space:pre-wrap;">Restart ssh</span></span><br /><span style="font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;"><span style="font-family:Courier New, Courier, monospace;">sudo service ssh restart</span></span><br /><span style="font-family:Arial;font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;"></span><br />okay now we need to take care of the ports, and really I could take you through a very complicated session of iptables, but if you are interested, read on "PORT KNOCKING" and "LIMIT RATES"</p>
<p>for the simplicity of my guid, i'll use gufw. </p></div>
<div><span style="font-family:'Courier New', Courier, monospace;font-size:15px;white-space:pre-wrap;">sudo apt-get install gufw</span></div>
<div><span style="font-family:'Courier New', Courier, monospace;font-size:15px;white-space:pre-wrap;"><br /></span></div>
<div>Launch it. </div>
<div>allow all outgoing and deny every incoming. </div>
<div></div>
<div class="separator" style="clear:both;text-align:left;"><a href="#" style="margin-left:1em;margin-right:1em;"><img border="0" height="640" src="/images/wp/93722-screenshotfrom2012-12-17192939.png?w=125" width="268" /></a></div>
<p>Click on edit, and add a rule, from specific subnet to the specific port, you can be as specific as to what ip, to, or what port number its emitting from. usually you don't specify what port from, clients like nexus, might be using ports not recognized by server. also add subnet for vpn.</p>
<div class="separator" style="clear:both;text-align:center;"><a href="#" style="margin-left:1em;margin-right:1em;"><img border="0" height="252" src="/images/wp/a89fb-screenshotfrom2012-12-17193356.png?w=300" width="640" /></a></div>
<div></div>
<div><span style="color:orange;">ON THE CLIENT</span><br /><span style="font-family:Courier New, Courier, monospace;"><span style="font-size:15px;font-weight:bold;vertical-align:baseline;white-space:pre-wrap;">sudo reboot now! </span><br /><span style="font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;">ssh -v -p </span></span><span style="font-size:15px;font-weight:bold;white-space:pre-wrap;"><span style="font-family:Courier New, Courier, monospace;">5848</span></span><span style="font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;"><span style="font-family:Courier New, Courier, monospace;"> kenneth@192.168.12.2        </span></span><span style="font-family:Arial;font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;">   </span><span style="font-family:Arial;font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;">                                                                                                                                                           </span><br /><span style="font-family:Arial;font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;"></span><br />this is a config file so that you can type ssh dv7 and get straight in.</div>
<div><span style="font-family:Courier New, Courier, monospace;"><span style="font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;">nano  ~/.ssh/config</span></span><br /><span style="font-family:Courier New, Courier, monospace;"><span style="font-size:15px;vertical-align:baseline;white-space:pre-wrap;">Host dv7</span></span><br /><span style="font-family:Courier New, Courier, monospace;"><span style="font-size:15px;vertical-align:baseline;white-space:pre-wrap;">    HostName 192.168.12.2</span></span><br /><span style="font-family:Courier New, Courier, monospace;"><span style="font-size:15px;vertical-align:baseline;white-space:pre-wrap;">    Port </span></span><span style="font-family:'Courier New', Courier, monospace;font-size:15px;font-weight:bold;white-space:pre-wrap;">5848</span><br /><span style="font-family:'Courier New', Courier, monospace;font-size:15px;white-space:pre-wrap;">    User kenneth</span><br /><span style="font-family:Arial;font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;"></span>
<div><span style="font-family:Arial;font-size:15px;white-space:pre-wrap;"><br /></span><span style="font-family:Arial;font-size:15px;white-space:pre-wrap;">this simple command should get you</span></div>
<div><span style="font-family:Arial;font-size:15px;vertical-align:baseline;white-space:pre-wrap;"> into ssh server</span><br /><span style="font-size:15px;vertical-align:baseline;white-space:pre-wrap;"><span style="font-family:Courier New, Courier, monospace;">ssh dv7</span></span><br /><span style="font-size:15px;vertical-align:baseline;white-space:pre-wrap;"><span style="font-family:Courier New, Courier, monospace;"><br /></span></span></div>
<p><span style="font-family:Arial;font-size:15px;font-weight:normal;vertical-align:baseline;white-space:pre-wrap;"><span style="color:orange;font-family:'Times New Roman';font-size:small;white-space:normal;">ON THE NEXUS</span></span><br /><span style="font-family:Arial;font-size:15px;white-space:pre-wrap;">long press the connection you have created and edit the port. </span><br /><span style="font-family:Arial;font-size:15px;white-space:pre-wrap;"><br /></span>
<div class="separator" style="clear:both;text-align:left;"><a href="#" style="margin-left:1em;margin-right:1em;"><img border="0" height="640" src="/images/wp/093a9-2012-12-1800-18-09.png?w=187" width="400" /></a></div>
<p><span style="font-family:Arial;font-size:15px;white-space:pre-wrap;"><br /></span></p>
<p>you should now be able to get in directly</p>
</div>
<div><b style="font-family:'Courier New', Courier, monospace;font-size:15px;white-space:pre-wrap;">Notes: </b></div>
<div><span style="font-family:inherit;white-space:pre-wrap;">There's always more you can do, I think the most important is to determine if you need ssh. </span></div>
<div><span style="font-family:inherit;white-space:pre-wrap;"><br /></span></div>
<div><span style="font-family:inherit;white-space:pre-wrap;">I only allow ssh on machines i need to run commands on. NFS, VPN, VNC etc servers do not need to always be ssh'd into.  </span></div>
<div><span style="font-family:inherit;white-space:pre-wrap;"><br /></span></div>
<div><span style="font-family:inherit;white-space:pre-wrap;">I build most of my servers in vm, and I rather make changes on virtual-manager, by connecting straight to the hypervisor. (I'll add links, when I post on my KVM setup.) </span></div>
<div><span style="font-family:inherit;white-space:pre-wrap;"><br /></span></div>
<div><span style="font-family:inherit;">also remember you refused access to your ssh by password, what that means is, if the client that copied the key, get to be reset, or wiped. you have no ways of connecting until you change that value</span><br /><span style="font-family:inherit;"><br /></span><span style="font-family:inherit;">People think it's absolutely unnecessary to have a password to a key pem, while you still connecting through vpn. I was hunting for the most secure way, so this is it.</span><br /><span style="font-family:inherit;"><br /></span><span style="font-family:inherit;">*thnx to carl for the email to fix post formatting</span><br /><span style="font-family:inherit;"><br /></span><span style="white-space:pre-wrap;"><span style="font-family:inherit;">to delete the key, you can use the following command</span></span><br /><span style="white-space:pre-wrap;"><span style="font-family:inherit;"><br /></span></span><span style="white-space:pre-wrap;"><span style="font-family:inherit;">oh and the android keyboard sucks, get the <a href="https://play.google.com/store/apps/details?id=org.pocketworkstation.pckeyboard" target="_blank">hacker's keyboard</a></span></span><span style="font-family:'Courier New', Courier, monospace;font-size:15px;white-space:pre-wrap;">cd ~/.ssh sed '/dv7$/d' authorized_keys | tee authorized_keys</span><br /><span style="font-family:'Courier New', Courier, monospace;font-size:15px;white-space:pre-wrap;"><br /></span><span style="font-family:'Courier New', Courier, monospace;font-size:15px;white-space:pre-wrap;"><br /></span></div>
